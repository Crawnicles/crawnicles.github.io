<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Post • Andrew Crawford</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0d0f12; --ink:#eef2f6; --muted:#a8b3bd; --ring:#2a2f36; --card:#151a20e6 }
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui; line-height:1.65}
    .wrap{max-width:820px; margin:0 auto; padding:2rem 1rem}
    .card{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:1.2rem}
    a{color:inherit}
    #title{font-family:"Noto Serif JP", serif; font-size:clamp(1.6rem,3.4vw,2.2rem); margin:.2rem 0 .5rem}
    #meta{color:var(--muted); margin-bottom:1rem}
    #content h1,#content h2,#content h3{font-family:"Noto Serif JP", serif}
    #content img{max-width:100%; border-radius:10px; border:1px solid var(--ring)}
    .back{display:inline-flex; gap:.5rem; align-items:center; margin-bottom:1rem; text-decoration:none;}
    .back span{border:1px solid var(--ring); border-radius:999px; padding:.2rem .6rem; background:#111a;}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="./"><span>⟵</span> Back to site</a>
    <div class="card">
      <div id="title"></div>
      <div id="meta" class="muted"></div>
      <div id="content"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
  (async function(){
    const qs        = new URLSearchParams(location.search);
    const src       = qs.get('src');                 // e.g. writings/2024-03-22-straight-by-28.md
    const qpTitle   = qs.get('title') || '';         // optional ?title=...
    const titleEl   = document.getElementById('title');
    const metaEl    = document.getElementById('meta');
    const contentEl = document.getElementById('content');

    if (!src) { contentEl.textContent = 'Missing ?src=...'; return; }

    // ---------- helpers ----------
    const fname = (src.split('/').pop() || '').trim();

    function deriveDateFromFilename(name){
      const m = name.match(/^(\d{4})-(\d{2})-(\d{2})-/);
      if (!m) return '';
      const d = new Date(`${m[1]}-${m[2]}-${m[3]}T12:00:00Z`);
      return isNaN(d) ? '' : d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    }

    function prettyTitleFromFilename(name){
      return name
        .replace(/^\d{4}-\d{2}-\d{2}-/, '') // strip date prefix
        .replace(/\.md$/,'')                // strip extension
        .replace(/-/g,' ')                  // dashes -> spaces
        .replace(/^./, c => c.toUpperCase());
    }

    // ---------- set immediate title & date (no "Loading…") ----------
    if (qpTitle) {
      titleEl.textContent = qpTitle;
    } else {
      titleEl.textContent = prettyTitleFromFilename(fname) || 'Untitled';
    }
    const derivedDate = deriveDateFromFilename(fname);
    if (derivedDate) metaEl.textContent = derivedDate;

    // ---------- fetch & render markdown ----------
    function fmtDate(d){ return new Date(d).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }

    try {
      // cache-bust to avoid stale JSON/MD on GitHub Pages
      const res = await fetch(src + '?v=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const text = await res.text();

      // Optional HTML comment frontmatter: <!-- date: 2025-02-11 -->
      const frontmatterDate = text.match(/<!--\s*date:\s*([^>]+)\s*-->/i);
      if (frontmatterDate) {
        const d = new Date(frontmatterDate[1]);
        if (!isNaN(d)) metaEl.textContent = fmtDate(d);
      } else if (!metaEl.textContent) {
        // already set from filename; keep it if present
        metaEl.textContent = derivedDate;
      }

      const md = text.replace(/<!--[^]*?-->/g,''); // strip comment frontmatter
      contentEl.innerHTML = marked.parse(md);

      // If no ?title=, prefer an in-document H1
      if (!qpTitle) {
        const firstH1 = contentEl.querySelector('h1');
        if (firstH1 && firstH1.textContent.trim()) {
          titleEl.textContent = firstH1.textContent.trim();
        }
      }
    } catch (e) {
      contentEl.textContent = 'Could not load post: ' + e.message;
    }
  })();
  </script>
</body>
</html>
